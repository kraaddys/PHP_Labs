# Лабораторная работа №5. Работа с базой данных

## Цель работы

Целью данной лабораторной работы является глубокое освоение базовых и среднеуровневых навыков веб-разработки на языке PHP с использованием реляционных баз данных. В рамках задания студент разрабатывает полнофункциональное веб-приложение, которое поддерживает операции создания, редактирования, удаления и просмотра записей (CRUD). Особое внимание уделяется построению архитектуры с единой точкой входа, правильному структурированию проекта, подключению и работе с базой данных MySQL с использованием расширения PDO, созданию шаблонов для визуального отображения контента, применению CSS-стилей, обеспечению безопасности за счёт защиты от SQL-инъекций и организации постраничной навигации (пагинации). Помимо этого, студент изучает, как документировать код с помощью стандарта PHPDoc, а также закрепляет принципы разделения логики и представления в архитектуре MVC.

## Подробное объяснение кода и компонентов проекта

### Подключение к базе данных (`src/db.php`)

Файл `db.php` содержит функцию `getPDO()`, которая создаёт и возвращает подключение к базе данных с использованием PDO:

```php
function getPDO(): PDO {
    $config = require __DIR__ . '/../config/db.php';
    $dsn = "mysql:host={$config['host']};dbname={$config['dbname']};charset=utf8mb4";
    return new PDO($dsn, $config['username'], $config['password'], [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
    ]);
}
```

Функция считывает настройки из конфигурационного файла `config/db.php`, формирует строку подключения `DSN`, инициализирует объект `PDO` и устанавливает режим обработки ошибок — `PDO::ERRMODE_EXCEPTION`, что означает выброс исключения при любой ошибке выполнения запроса. Это упрощает отладку и позволяет более точно отслеживать проблемы в работе с базой данных.

### Точка входа и маршрутизация (`public/index.php`)

Вся маршрутизация реализована через один файл — `index.php`. Этот подход создаёт архитектуру с единой точкой входа, позволяя гибко управлять отображением страниц и логикой приложения. Используется параметр `$_GET['page']`, по значению которого определяется, какую часть логики подключить:

```php
$page = $_GET['page'] ?? 'index';
switch ($page) {
    case 'create': require 'src/handlers/recipe/create.php'; break;
    case 'edit': require 'src/handlers/recipe/edit.php'; break;
    case 'delete': require 'src/handlers/recipe/delete.php'; break;
    case 'show': require 'templates/recipe/show.php'; break;
    default: require 'templates/index.php';
}
```

Такой способ построения маршрутизации удобен, масштабируем и позволяет централизованно контролировать доступ к файлам.

### Обработка создания рецепта (`src/handlers/recipe/create.php`)

Обработчик получения данных из формы создания рецепта выглядит следующим образом:

```php
$stmt = $pdo->prepare("INSERT INTO recipes (title, category, ingredients, description, tags, steps) VALUES (?, ?, ?, ?, ?, ?)");
$stmt->execute([$title, $category, $ingredients, $description, $tags, $steps]);
```

Пользователь вводит данные в форму. Эти данные проходят через фильтрацию и валидацию, после чего с помощью метода `prepare()` создаётся SQL-запрос. Метод `execute()` подставляет значения, гарантируя безопасность и защиту от SQL-инъекций. Использование знаков `?` позволяет избежать внедрения вредоносного SQL-кода.

### Отображение рецептов (`templates/index.php`)

```php
$stmt = $pdo->prepare("SELECT recipes.*, categories.name AS category_name FROM recipes JOIN categories ON recipes.category = categories.id ORDER BY created_at DESC LIMIT :limit OFFSET :offset");
$stmt->bindValue(':limit', $limit, PDO::PARAM_INT);
$stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
$stmt->execute();
```

Здесь осуществляется выборка всех рецептов из таблицы `recipes` с присоединением таблицы `categories`, чтобы получить имя категории. Также реализована пагинация: в запрос подставляется ограничение по количеству и смещение (offset), чтобы выводить рецепты порциями по 5 штук на страницу. Это обеспечивает масштабируемость и улучшает UX.

### Шаблонизация (`templates/layout.php`)

```php
<body>
  <h1><a href="index.php">Книга рецептов</a></h1>
  <nav>
    <a href="?page=index">Главная</a>
    <a href="?page=create">Добавить рецепт</a>
  </nav>
  <?= $content ?>
</body>
```

Файл `layout.php` играет роль базового шаблона для всех страниц. Через переменную `$content` вставляется содержимое конкретной страницы, предварительно сформированное через `ob_start()` и `ob_get_clean()` в других файлах. Это позволяет избежать дублирования HTML-кода и централизовать структуру сайта.

### Стилизация

CSS-оформление встроено в шаблон `layout.php`. Используются переменные для цветов, оформление форм, кнопок, навигации, адаптивность для мобильных устройств. Элементы UI (формы, списки, навигация) оформлены с помощью современных CSS-техник, что придаёт приложению аккуратный и современный вид.

---

## Вывод (расширенный)

В ходе выполнения лабораторной работы было разработано полнофункциональное веб-приложение на языке PHP, взаимодействующее с базой данных MySQL посредством безопасного и надёжного расширения PDO. Мы научились строить архитектуру с единой точкой входа, использовать шаблоны для представлений, подключать стили и применять защиту от SQL-инъекций. Все основные операции CRUD были реализованы и протестированы.

Особое внимание было уделено правильной структуре проекта: были разделены слои логики и представления, все действия пользователя обрабатываются соответствующими обработчиками. Применение PDO гарантирует защиту от атак, связанных с внедрением SQL-кода. Дополнительно была реализована пагинация, что делает интерфейс более удобным для пользователя и улучшает восприятие большого количества информации.

Визуальная составляющая проекта была оформлена с помощью CSS, что позволило сделать внешний вид приятным и логически структурированным. Подход с шаблонизацией обеспечил переиспользуемость кода и упрощение поддержки приложения. Все функции снабжены комментариями в формате PHPDoc, что облегчает навигацию и понимание логики приложения другими разработчиками.

Таким образом, проект получился не просто учебным, а вполне пригодным для расширения и использования в реальных задачах. Его можно легко масштабировать, добавив регистрацию, авторизацию, систему тегов, поиск и другие функции.

---

## Развёрнутые ответы на контрольные вопросы

### 1. Преимущества единой точки входа

Единая точка входа (Single Entry Point) означает, что всё приложение запускается через один файл (обычно `index.php`). Такой подход позволяет:

* Централизованно контролировать логику маршрутизации и безопасности.
* Организовать единое место для подключения middleware (например, логгирование, авторизация).
* Обеспечить защиту от прямого доступа к файлам, которые не должны вызываться напрямую (например, обработчики или файлы конфигурации).
* Сократить дублирование кода и обеспечить единообразную обработку запросов.

В результате, приложение становится более масштабируемым, безопасным и легко сопровождаемым.

### 2. Преимущества шаблонов

Шаблоны (templates) позволяют отделить бизнес-логику приложения от визуального отображения. Это важный принцип в архитектуре MVC, благодаря которому:

* Обеспечивается переиспользование элементов (например, общая шапка, футер, меню).
* Повышается читаемость кода: разработчик может быстро найти нужную часть интерфейса без погружения в бизнес-логику.
* Упрощается внесение изменений в дизайн: один файл `layout.php` контролирует внешний вид сразу всех страниц.
* Создаётся возможность подключать шаблонизаторы (например, Twig, Blade), если проект будет расширяться.

### 3. Преимущества хранения данных в базе по сравнению с файлами

| Критерий               | Файловая система                         | Реляционная БД (MySQL)                 |
| ---------------------- | ---------------------------------------- | -------------------------------------- |
| Скорость поиска        | Линейный перебор                         | Индексация, высокая скорость           |
| Безопасность           | Нет встроенной защиты                    | Поддержка ролей, прав доступа          |
| Связи между сущностями | Реализуются вручную                      | Foreign key, нормализация              |
| Обновление и удаление  | Затруднено, особенно при больших объёмах | Быстро, с помощью SQL-запросов         |
| Масштабируемость       | Плохо масштабируется                     | Хорошо масштабируется                  |
| Консистентность данных | Нет механизмов контроля целостности      | Есть проверки ограничений и транзакции |

### 4. Что такое SQL-инъекция и как её предотвратить

SQL-инъекция — это вид уязвимости, при которой злоумышленник вставляет вредоносный SQL-код в поля ввода или URL, что может привести к изменению поведения запроса и несанкционированному доступу к данным.

**Пример атаки:**

```php
$login = $_POST['login'];
$query = "SELECT * FROM users WHERE login = '$login'";
```

Если пользователь введёт `admin' --`, то SQL-запрос превратится в:

```sql
SELECT * FROM users WHERE login = 'admin' --'
```

Таким образом, злоумышленник сможет получить доступ без ввода пароля.

**Как предотвратить:**

* Использовать `prepare()` и `execute()` вместо вставки данных напрямую в запрос.
* Проверять и фильтровать пользовательский ввод.
* Использовать параметризованные запросы (с `?` или `:name`).
* Применять минимальные привилегии для учётной записи БД.

**Правильный подход:**

```php
$stmt = $pdo->prepare("SELECT * FROM users WHERE login = ?");
$stmt->execute([$login]);
```

Такой запрос безопасен, потому что пользовательский ввод не влияет на структуру SQL.

---

## Источники (с описанием)

* **[PHP PDO Docs](https://www.php.net/manual/en/book.pdo.php)** — официальная и наиболее авторитетная документация по расширению PDO в PHP. Описывает все методы работы с базой данных, включая подготовленные выражения, транзакции, подключение, управление ошибками и др.

* **[W3Schools: PHP Prepared Statements](https://www.w3schools.com/php/php_mysql_prepared_statements.asp)** — обучающая статья с примерами, объясняющая преимущества подготовленных выражений и пошагово показывающая, как их реализовать.

* **[MDN: SQL Injection](https://developer.mozilla.org/en-US/docs/Learn/Server-side/SQL_injection)** — статья от Mozilla, описывающая принцип SQL-инъекций, механизмы эксплуатации и способы защиты. Подходит как для новичков, так и для опытных разработчиков.

* **[PHP htmlspecialchars()](https://www.php.net/manual/en/function.htmlspecialchars.php)** — функция, обеспечивающая защиту от XSS-атак путём экранирования специальных HTML-символов. Необходима при выводе пользовательских данных в HTML-шаблонах.
